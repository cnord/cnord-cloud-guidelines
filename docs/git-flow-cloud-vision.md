# “git-flow” и версионирование пакетов/микросервисов/продуктов

*Цель документа* – описать git-flow и принципы версионирования пакетов в рамках всех репозиториев входящих в зону ответственности команд Облака.

*Статус документа*: в настоящий момент описан общий принцип git flow и версионирование в рамках репозитория *private-cloud* и *cloud-docker*.

* 1\. [Git-flow](#git-flow)
* 2\. [Схемы версионирования](#схемы-версионирования)
  * 2.1. [Репозиторий private-cloud](#репозиторий-private-cloud)
  * 2.2. [Репозиторий cloud-docker](#репозиторий-cloud-docker)
  * 2.3. [Примеры версионирования private-cloud](#примеры-версионирования-private-cloud)
  * 2.4. [Бэкпорты фичей / багфиксов](#бэкпорты-фичей--багфиксов)
    * 2.4.1. [Сценарии багфиксов](#сценарии-багфиксов)
    * 2.4.2. [Примеры бэкпортов фичей / багфиксов](#примеры-бэкпортов-фичей--багфиксов)


## Git-flow

Предлагаемый git-flow основан на следующих идеях:

1. *master* – ветка, содержащая самую актуальную на текущий момент кодовую базу. Пакеты (образы и пр.) представленные в этой ветки могут быть уже зарелижены или еще нет.
2. Фичеветки / багфиксы заводятся относительно мастера и вливаются обратно с `--no-ff` в мастер (см. исключение в п.7). Вливаемые ветки должны быть предварительно отребейзаны на мастер. Сообщение коммита при влитии должно быть в формате "[master] yyy-xxxx Описание фичи / багфикса", *yyy-xxxx* – идентификатор задачи из JIRA.
3. Для выполняемых задач должны быть заведены ветки относительно соответствующих фичеветок. В процессе разработки эти ветки ребейзятся на родительскую фичеветку и вливаются с `--squash`. Сообщение коммита должно содержать сообщение выполненной задачи в формате "[yyy-xxxx] Описание решаемой задачи". НЕ допускается оставлять сообщения схлопнутых коммитов, т.к. смысловой нагрузки после влития в фичеветку они не несут.
4. *Релиз* – процесс, по результатам которого, имеющие изменения пакеты получают версии в соответствии с принятой системой версионирования и публикуются в репозитории (pypi или иной). Окончание релиза завершается выставлением в git-репозитории тегов выпущенных пакетов.
5. Версии затрагиваемых пакетов и зависимых пакетов поднимаются *сразу* при выполнения задачи с добавлением постфикса "*devN*" (*dev0*, *dev1*, ...), с учетом принятой системой версионирования (*N* является инкреметальным счетчиком вносимых изменений и должен увеличиваться в каждой новой задаче, если на момент работы постфикс *dev* уже присутствовал). Таким образом решаются две задачи:
    * Маркируется изменившийся пакет.
    * Определяются корректные зависимости от этого пакета в других пакетах, если таковые имеются.
6. При разрешении конфликтов перед влитием веток (ребейз фичеветки на мастер, ветки разработчика на фичеветку), при необходимости, разрешаются конфликты версий пакетов, а также их зависимостей, в соответствии с принятой системой версионирования.
7. Релиз производится, как правило, из ветки *master*. В случае, когда необходимы бэкпорты / багфиксы относительно конкретной версии релиза пакета, заводится соответствующая релизная ветка из тега этого релиза. В зависимости от контекста задачи, фичеветки заводятся и вливаются в релизную ветку, либо в релизную ветку привносятся необходимые коммиты из мастера (см. более подробно "[Бэкпорты фичей / багфиксов](#бэкпорты-фичей--багфиксов)").
8. Из предыдущего пункта следует, что порядок версий пакета может не соответствовать порядку даты и времени выпуска его (пакета) версий.


## Схемы версионирования


### Репозиторий private-cloud

1. Версионирование всех пакетов Облака предлагается делать по [Semver][semver], таким образом делая их независимыми как друг от друга, так и от версии продуктов. При разрешении конфликтов перед влитием веток (ребейз фичеветки на мастер, ветки разработчика на фичеветку) побеждает более старшая версия пакета.
2. Версия пакета при разработке (согласно п.5 git-flow) должна быть изменена в соответствии с характером вносимых изменений. Например, пакет версии *wheelgate 7.0.1.dev0* означает баг фикс, *wheelgate 7.1.0.dev0* – новая фича в пакете с сохранением обратной совместимости, *wheelgate 8.0.0.dev0* – изменения, ломающие обратную совместимость.
3. Зависимости пакетов, которые сами являются / могут являться зависимостями других пакетов (например *tippetop*, *candies*, *hammond* и пр.), *должны* рассматриваться как часть предоставляемого API. Повышение мажорной версии какой-либо зависимости такого пакета *должно* приводить к повышению мажорной версии *самого пакета*, поскольку новая зависимость не обспечивает обратной совместимости при установке и разрешении транзитивных зависимостей.
4. Релизы пакетов могут не быть синхронизированы между собой.
5. Релиз пакетов не связан с релизом продуктов.
6. На момент релиза пакетов из версий достаточно убрать постфиксы "*devN*", т.к. семантика версии уже отражает произошедшие изменения.
7. В ветке, из которой выпускается релиз пакетов (см. п.7 описания git-flow, когда это может быть не мастер), проставляется теги релизов пакетов в формате *package-name-MAJOR.MINOR.PATCH*. Например, hammond-7.11.0.
8. Не допускается публикация пакетов с dev-версиями в репозиторий. Если необходимо выпустить пакет не дожидаясь формального процесса релиза (например, с целью тестирования решения на стенде, подготовки docker-образа и т.д.), следует использовать постфиксы пре-релиза "*aN*", "*bN*", "*rcN*" (a0, b1, rc1 и т.д.) в версии пакета, согласно [PEP 440][pep440].


### Репозиторий cloud-docker

1. С точки зрения cloud-docker версионированию подлежит *продукт*, как набор версий взаимосвязанных компонентов (docker-образов), их конфигов и скриптов развертывания (плейбуков).
2. Версионирование продукта предлагается делать по схеме *YY.MM.DD.INC*, где *YY*, *MM* и *DD* – год, месяц и день релиза версии продукта, *INC* – инкремент очередного релиза в рамках *YY.MM.DD* (указывается при необходимости, по умолчанию 0).
3. Релиз завершается выставлением в репозитории тега релиза вида *product-name-YY.MM.DD.INC*. Например, *cloud-18.12.01.2*
4. (требует обсуждения и доработки) Одному python-пакету могут соответствовать несколько docker-образов. 1) Для одного и того же python-пакета не гарантируется детерминированность сборки образа. (раскрыть что это значит). 2) Образ может быть собран с другими переменными плейбука / окружения / конфигами / бинарными зависимостями и т.д. В идеальном мире, следует отвязать версию образа от версии python-пакета, например, добавив к версии постфикс *buildN*.


### Примеры версионирования private-cloud

#### Пример 1: одна история – один релиз

Дано:

Пусть есть история про добавление новой фичи, с трем задачами, которые затрагивают:

* в задаче *task-hammond*: компоненеты *hammond*, *tippetop-main*, *tippetop-cml*;
* в задаче *task-wheelgate*: компоненты *wheelgate*, *tippetop-main*;
* в задаче *task-keyboardist*: компоненты *keyboardist*, *tippetop-main*.

Версии пакетов в мастере:

* *keyboardist 7.5.0*
* *wheelgate 7.6.0*
* *hammond 7.3.2*
* *tippetop-main 1.4.0*
* *tippetop-cml 1.1.0*

Описание git-flow в картинках:

Шаг 1: заведена фичеветка, заведены ветки с задачами от фичеветки, в ветках с задачми сделаны коммиты

1. Заводится фичеветка *feature-story*.
2. Для каждой задачи заводится своя ветка *task-hammond*, *task-wheelgate*, *task-keyboardist*.
3. В ветке *task-hammond* поднимаются версии компонентов (не забывая постфикс "*dev*"):
    * *tippetop-main 1.4.0 → 1.5.0.dev0* (изменения обратно совместимые).
    * *tippetop-cml 1.1.0 → 1.2.0.dev0* (совместимые изменения).
    * *hammond 7.3.2 → 7.4.0.dev0* (изменения обратно совместимые); поднимается зависимость *tippetop-main 1.5.0.dev0* и *tippetop-cml 1.2.0.dev0*.
4. В ветке *task-wheelgate* поднимаются версии компонентов:
    * *tippetop-main 1.4.0 → 1.5.0.dev0*.
    * *wheelgate 7.6.0 → 7.7.0.dev0*; поднимается зависимость *tippetop-main* до *1.5.0.dev0*.
5. В ветке *task-keyboardist* поднимаются версии компонентов:
    * *tippetop-main 1.4.0 → 2.0.0.dev0*.
    * *keyboardist 7.5.0 → 7.6.0.dev0*, поднимается зависимость *tippetop-main* до *2.0.0.dev0*.

```
---------------------o  master
                     |    - tippetop-main 1.4.0
                     |    - tippetop-cml  1.1.0
                     |    - keyboardist   7.5.0
                     |    - wheelgate     7.6.0
                     |    - hammond       7.3.2
                     |
                     |
                     |
                     o-------- feature-story
                     |
                     |
                     |-A--B--C task-keyboardist
                     |           - tippetop-main  2.0.0.dev0
                     |           - keyboardist    7.6.0.dev0
                     |
                     |---D--E  task-wheelgate
                     |           - tippetop-main  1.5.0.dev0
                     |           - wheelgate      7.7.0.dev0
                     |
                     \---F--G  task-hammond
                                 - tippetop-main  1.5.0.dev0
                                 - tippetop-cml   1.2.0.dev0
                                 - hammond        7.4.0.dev0
```

Шаг 2: влитие ветки *task-keyboardist* → *feature-story*

```shell
$ git checkout feature-story
$ git merge task-keyboardist --squash
>> [CLD-0001] summary of the first completed task
```

```
---------------------o  master
                     |    - tippetop-main 1.4.0
                     |    - tippetop-cml  1.1.0
                     |    - keyboardist   7.5.0
                     |    - wheelgate     7.6.0
                     |    - hammond       7.3.2
                     |
                     |
                     |
                     o--------------------K' feature-story
                     |                    |    - tippetop-main  2.0.0.dev0
                     |                    |    - keyboardist    7.6.0.dev0
                     |                    |
                     |                    |
                     |-A--B--C------------/  task-keyboardist
                     |                         - tippetop-main  2.0.0.dev0
                     |                         - keyboardist    7.6.0.dev0
                     |
                     |---D--E  task-wheelgate
                     |           - tippetop-main  1.5.0.dev0
                     |           - wheelgate      7.7.0.dev0
                     |
                     \---F--G  task-hammond
                                 - tippetop-main  1.5.0.dev0
                                 - tippetop-cml   1.2.0.dev0
                                 - hammond        7.4.0.dev0
```

Шаг 3: ребейз ветки *task-wheelgate* на *feature-story*. После ребейза (перед влитием), конфликты версии пакета *tippetop-main* разрешаем в сторону мажорной версии *1.5.0.dev0* → *2.0.0.dev0*. Там же актуализируем зависимости *wheelgate*: *tippetop-main* *1.5.0.dev0* → *2.0.0.dev0*.

```shell
$ git checkout task-wheelgate
$ git rebase feature-story
```

```
---------------------o  master
                     |    - tippetop-main 1.4.0
                     |    - tippetop-cml  1.1.0
                     |    - keyboardist   7.5.0
                     |    - wheelgate     7.6.0
                     |    - hammond       7.3.2
                     |
                     |
                     |
                     o--------------------K'    feature-story
                     |                    |       - tippetop-main       2.0.0.dev0
                     |                    |       - keyboardist         7.6.0.dev0
                     |                    |
                     |                    \--D'--E'  task-wheelgate
                     |                                 - tippetop-main  1.5.0.dev0 -> 2.0.0.dev0 (conflict resolved)
                     |                                 - wheelgate      7.7.0.dev0
                     |
                     \---F--G  task-hammond
                                 - tippetop-main  1.5.0.dev0
                                 - tippetop-cml   1.2.0.dev0
                                 - hammond        7.4.0.dev0
```

Шаг 4: влитие ветки *task-wheelgate* → *feature-story*

```shell
$ git checkout feature-story
$ git merge task-wheelgate --squash
>> [CLD-0002] summary of the second completed task
```

```
---------------------o  master
                     |    - tippetop-main 1.4.0
                     |    - tippetop-cml  1.1.0
                     |    - keyboardist   7.5.0
                     |    - wheelgate     7.6.0
                     |    - hammond       7.3.2
                     |
                     |
                     |
                     o--------------------K'----------W'   feature-story
                     |                    |           |      - tippetop-main  2.0.0.dev0
                     |                    |           |      - keyboardist    7.6.0.dev0
                     |                    |           |      - wheelgate      7.7.0.dev0
                     |                    |           |
                     |                    \--D'--E'---/    task-wheelgate
                     |                                       - tippetop-main  2.0.0.dev0
                     |                                       - wheelgate      7.7.0.dev0
                     |
                     \---F--G  task-hammond
                                 - tippetop-main  1.5.0.dev0
                                 - tippetop-cml   1.2.0.dev0
                                 - hammond        7.4.0.dev0
```

Шаг 5: ребейз ветки *task-hammond* на *feature-story*. После ребейза ветки *task-hammond* на фичеветку, разрешаем конфликты версии пакета *tippetop-main* также сторону мажорной версии, а у пакета *hammond* поднимаем версию пакета *tippetop-main* до *2.0.0.dev0*.

```shell
$ git checkout task-hammond
$ git rebase feature-story
```

```
---------------------o  master
                     |    - tippetop-main 1.4.0
                     |    - tippetop-cml  1.1.0
                     |    - keyboardist   7.5.0
                     |    - wheelgate     7.6.0
                     |    - hammond       7.3.2
                     |
                     |
                     |
                     \--------------------K'----------W'   feature-story
                                                      |       - tippetop-main  2.0.0.dev0
                                                      |       - keyboardist    7.6.0.dev0
                                                      |       - wheelgate      7.7.0.dev0
                                                      |
                                                      \---F'--G'  task-hammond
                                                                    - tippetop-main  1.5.0.dev0 -> 2.0.0.dev0 (conflict resolved)
                                                                    - tippetop-cml   1.2.0.dev0
                                                                    - hammond        7.4.0.dev0
```

Шаг 6: влитие ветки *task-hammond* → *feature-story*

```shell
$ git checkout feature-story
$ git merge task-hammond --squash
$ git commit
>> [CLD-0003] summary of another completed task
```

```
---------------------o  master
                     |    - tippetop-main 1.4.0
                     |    - tippetop-cml  1.1.0
                     |    - keyboardist   7.5.0
                     |    - wheelgate     7.6.0
                     |    - hammond       7.3.2
                     |
                     |
                     |
                     \--------------------K'----------W'----------H'  feature-story
                                                      |           |     - tippetop-main  2.0.0.dev0
                                                      |           |     - tippetop-cml   1.2.0.dev0
                                                      |           |     - keyboardist    7.6.0.dev0
                                                      |           |     - wheelgate      7.7.0.dev0
                                                      |           |     - hammond        7.4.0.dev0
                                                      |           |
                                                      \---F'--G'--/   task-hammond
                                                                        - tippetop-main  2.0.0.dev0
                                                                        - tippetop-cml   1.2.0.dev0
                                                                        - hammond        7.4.0.dev0
```

Шаг 7: влитие *feature-story* → *master*.

```shell
$ git checkout feature-story
$ git rebase master
Current branch feature-story is up to date.
$ git checkout master
$ git merge feature-story --no-ff
```

```
---------------------o------------------------------------------FEATURE---  master
                     |                                            |           - tippetop-main  2.0.0.dev0
                     |                                            |           - tippetop-cml   1.2.0.dev0
                     |                                            |           - keyboardist    7.6.0.dev0
                     |                                            |           - wheelgate      7.7.0.dev0
                     |                                            |           - hammond        7.4.0.dev0
                     |                                            |
                     |                                            |
                     |                                            |
                     \--------------------K'----------W'----------H'        feature-story
                                                                              - tippetop-main  2.0.0.dev0
                                                                              - tippetop-cml   1.2.0.dev0
                                                                              - keyboardist    7.6.0.dev0
                                                                              - wheelgate      7.7.0.dev0
                                                                              - hammond        7.4.0.dev0
```

Шаг 8: выпуск пакетов. В мастере, во всех пакетах и зависимостях, убираются постфиксы "*devN*", коммитятся изменения, выпускаются соответствующие пакеты, ставятся теги: *tippetop-main-2.0.0*, *tippetop-cml-1.2.0*, *keyboardist-7.6.0*, *wheelgate-7.7.0*, *hammond-7.4.0*.

```
--------------------------------------FEATURE--------------------------------------        master
                                        - tippetop-main  2.0.0.dev0                          - tippetop-main  2.0.0
                                        - tippetop-cml   1.2.0.dev0                          - tippetop-cml   1.2.0
                                        - keyboardist    7.6.0.dev0                          - keyboardist    7.6.0
                                        - wheelgate      7.7.0.dev0                          - wheelgate      7.7.0
                                        - hammond        7.4.0.dev0                          - hammond        7.4.0
```

#### Пример 2: две истории – один релиз

Дано:

В мастер влита фичеветка из предыдущего примера, но релиз еще не выпускался, т.е. есть пакеты имеющие постфикс "*devN*".

Есть история про добавление новой фичи, с двумя задачами:

* в задаче *task-wheelgate*: компоненты *wheelgate*, *tippetop*;
* в задаче *task-morty*: компоненты *morty*, *tippetop-main*.

Версии пакетов в мастере:

* *hammond 7.4.0.dev0*
* *morty 8.8.0*
* *wheelgate 7.7.0.dev0*
* *keyboardist 7.6.0.dev0*
* *tippetop-main 2.0.0.dev0*
* *tippetop-cml 1.2.0.dev0*

Описание git-flow:

1. Заводится фичеветка *feature-story-2*.
2. Для каждой задачи заводится своя ветка *task-morty*, *task-wheelgate*.
3. Версии пакетов в ветке *task-morty*:
    * *tippetop-main* (появляются совместимые изменения) версия *2.0.0.dev0* – версия этого пакета (пришедшая из мастера) не меняется, новые изменения укладываются в Semver.
    * morty *8.8.0* → *8.9.0.dev0* – повышается версия пакета, добавляется постфкис "*devN*".
4. Версии пакетов в ветке *task-wheelgate*:
    * *tippetop-cml* (есть несовместимые изменения), версия пакета *1.2.0.dev0* → *2.0.0.dev0*, мажорная версия поднимается согласно Semver. Зависимости от этого пакета также нужно обновить *1.2.0.dev0* → *2.0.0.dev0*.
    * *wheelgate* (появляются совместимые изменения) версия *7.7.0.dev0* не изменяется согласно Semver.
5. Ветки ребейзятся на фичеветку и вливаются со `--squash`.
6. Фичеветка ребейзится на мастер и вливается с `--no-ff`.
7. В мастере, во всех пакетах и зависимостях, убираются постфиксы "*dev*":
    * *tippetop-main 2.0.0.dev0 → 2.0.0*
    * *tippetop-cml 2.0.0.dev0 → 2.0.0*
    * *hammond 7.4.0.dev0 → 7.4.0*
    * *morty 8.9.0.dev0 → 8.9.0*
    * *wheelgate 7.7.0.dev0 → 7.7.0*
    * *hammond 7.4.0.dev0 → 7.4.0*
    * *keyboardist 7.6.0.dev0 → 7.6.0*
8. Изменения комитятся, выпускаются соответствующие пакеты, ставится теги пакетов.


### Бэкпорты фичей / багфиксов

Основные идеи:

1. Любой бэкпорт подразумевает создание *релизной* ветки из тега релиза пакета(-ов). В этой ветке будут содержаться коммиты фичей / багфиксов и из нее будет производится релиз пакета(-ов).
2. Бэкпорты фичей подразумевают ручной перенос коммитов (`git cherry-pick`) этих фичей либо из master-ветки, либо из соответствующей фичеветки (возможно, предварительно схлопнув их через `squash`).
3. Бэкпорт *фичи* повышает *минорную* версию релиза пакета.
4. Бэкпорт *багфиксов* повышает *патч* версию релиза пакета.
5. Можно выделить два способа бэкпортов багфиксов:
    * *Из* master-ветки. Выполняется аналогично бэкпорту фичей.
    * *В* master-ветку. Багфикс делается точечно в конкретной версии пакета(-ов), после чего изменения переносятся в master-ветку.
6. Способ багфикса зависит от контекста задачи. Например, в случае обнаружения бага на Проде и необходимости его срочного устранения, багфикс должен быть сделан сначала в соответствующей релизной ветке пакета, а потом, если это требуется, перенесен в master-ветку. Однако если баг не был явно обнаружен на Проде, но существует и исправлен в очердном релизе пакета, то багфикс может быть принесен из мастера в целевой релиз пакета.
7. Релизная ветка с бэкпортом НЕ вливается обратно в мастер, посколько содержащиеся в ней изменения либо уже перенесены из мастера, либо будут перенесны в мастер.
8. Перед бэкпортированием должно быть принято решение, должны ли попасть бэкпорты в более старшие версии (см. "[Сценарии багфиксов](#сценарии-багфиксов)"). Файлы чейнджлогов для выпущенных версий должны быть актуализированы в мастере.

Пример git-flow переноса багфиксов *из* master-ветки в релизные:

```
------x----------------x--------------x--------------BF1-------------------x---------------BF2-------------------------x- > master
      ^                ^              ^               ^                    ^                ^                          ^
  hammond 7.3.0   hammond 7.4.0    hammond 7.5.0  hammond 7.5.1.dev0   hammond 7.5.1    hammond 7.5.2.dev0          hammond 7.5.2
                       |
                       |
                       \----------BF1'---------------x----> release-hammond-with-bugfix-1
                                   ^                 ^
                            hammond 7.4.1.dev0    hammond 7.4.1
                                                    |
                                                    |
                                                    \---------BF2'-------------------x----> release-hammond-with-bugfix-2
                                                               ^                     ^
                                                          hammond 7.4.2.dev0      hammond 7.4.2
```

*BF1* и *BF2* – коммиты багфиксов в master-ветке.

*BF1'* и *BF2'* – результат переноса (`git cherry-pick`) коммитов *BF1* и *BF2* соответственно.


#### Сценарии багфиксов

Возможны два сценария багфиксов:

1. Багфикс попадает *только в конкретную* мажорно-минорную версию пакета (== MAJOR.MINOR.x) и, если необходимо, в мастер.
2. Багфикс попадает в конкретную и в *более старшие версии* мажорно-минорной версии ( >= MAJOR.MINOR.x), и, если необходимо, в мастер.

Для удобства рассмотрения примеров этих сценариев примем следующие допущения:

1. Багфикс затрагивает только один пакет (например *tippetop-cml*).
2. История версий пакетов будет представлена на оси версий, имеющей порядок по Semver. Например:

```
----x---------x--------x-------x------> tippetop-cml
    ^         ^        ^       ^
   1.1.0(П)  1.2.0    1.2.1   2.0.0.dev0
```

Здесь версия 1.1.0 – выпущенный пакет *tippetop-cml*, который попал на Прод, 1.2.0 и 1.2.1 – выпущенные пакеты не попавшие на Прод, 2.0.0.dev0 – еще невыпущенный пакет.

##### Сценарий 1

История пакета:

```
----x---------x-------x-------x-------x---------x--------x------> tippetop-cml
    ^         ^       ^       ^       ^         ^        ^
   1.1.1(П)  1.1.2   1.2.0   1.2.1   2.0.0    2.1.0    2.2.0.dev0
```

Найден баг в пакете *tippetop-cml 1.1.1*. Требование – выпустить пакет в рамках той же *мажорно-минорной* версии.

Решение:

На оси уже имеется версия 1.1.2 с некоторым багфиксом, поэтому новая версия получит номер 1.1.3. Фактически в новой версии будет два багфикса.

Пример git-flow:

1. Заводится релизная ветка *release-tippetop-cml-1.1.x* от тега *tippetop-cml-1.1.2*
2. В релизной ветке делается необходимый багфикс.
3. В релизной ветке ставится тег *tippetop-cml-1.1.3*, выпускается пакет.
4. Если известно, что баг проявляется на *всех* более поздних релизах пакета, то багфикс должен попасть в мастер.

##### Сценарий 2

История пакета:

```
----x---------x-------x-------x-------x---------x--------x------> tippetop-cml
    ^         ^       ^       ^       ^         ^        ^
   1.1.1(П)  1.1.2   1.2.0   1.2.1   2.0.0    2.1.0    2.2.0.dev0
```

Требование – выпустить багфикс во той же *мажорной-минорной* версии и всех более старших пакетах.

Решение: аналогично сценарию 1, но должны быть выпущены пакеты с фиксом в остальных версиях, т.е.:

* 1.1.1 → 1.1.3
* 1.2.1 → 1.2.2
* 2.0.0 → 2.0.1
* 2.1.0 → 2.1.1

Пример git-flow аналогичен предыдущему сценарию, но для каждого релиза *tippetop-cml* старше 1.1.1: завести аналогичные релизные ветки, внести багфиксы, выпустить пакеты.


#### Примеры бэкпортов фичей / багфиксов

##### Пример 1 – одна релизная ветка с багфиксом

Был обнаружен критический баг на Проде релиза Облака. По результатам исследования, баг находится в связке пакетов *hammond 7.3.0* и *tippetop-cml 1.0.0*.

Также известно, что баг проявляется / будет проявляться и на более старших пакетах.

Мастер имеет следующий вид:

```
---x--------------------x---------------------x-------------------x--------------------x-----------------x------ > master
   ^                    ^                     ^                   ^                    ^                 ^
 tippetop-cml 1.0.0(П)  hammond 7.3.0(П)      tippetop-cml 1.1.0   tippetop-cml 1.2.0   hammmond 7.4.0  hammond 7.5.0
```

Необходимо выпустить релиз с фиксом бага относительно *hammond-7.3.0* и *tippetop-cml-1.0.0*. Багфикс также должен попасть в мастер.

Описание git-flow:

Багфикс в конкретной версии приведет к увеличению *PATCH* версии релиза *hammond* и *tippetop-cml*.

Git-flow будет иметь следующий вид:

```
---x--------------------x---------------------x-------------------x--------------------x-----------------x--------------FIX'-- > master
   ^                    ^                     ^                   ^                    ^                 ^               ^
 tippetop-cml 1.0.0(П)  hammond 7.3.0(П)    tippetop-cml 1.1.0   tippetop-cml 1.2.0   hammmond 7.4.0   hammond 7.5.0  hammond 7.5.1.dev0
                        |                                                                                             tippetop-cml 1.2.1.dev0
                        |
                        |
                        |
                        o------------FIX-----x > release-hammond-bugfix
                        |            /       ^
                        |           /      hammond 7.3.1 (зависим от tippetop-cml == 1.0.1)
                        |          /       tippetop-cml 1.0.1
                        |         /
                        |        /
                        \-------/ > bug-fix
```

1. От тега *hammond-7.3.0* заводится релизная ветка *release-hammond-7.3.x*.
2. От релизной ветки *release-hammond-bugfix* заводится ветка с багфиксом *bug-fix*.
3. В ветке *hammond-bug-fix* повышаются версии пакетов:
    * *hammond 7.3.0* → *7.3.1.dev0*.
    * *tippetop-cml 1.0.0* → *1.0.1.dev0*.
4. Зависимость *hammond* от *tippetop-cml* должна быть строго зафиксирована (tippetop-cml == 1.0.1.dev0), чтобы избежать установки более свежих пакетов, в которых багфикса нет.
5. Ветка *bug-fix* вливается в ветку *release-hammond-bugfix* с `--squash`.
6. Готовится релиз пакетов с багфиксом из ветки *release-hammond-bugfix*:
    * В ветке убираются постфиксы "dev" в версиях пакетов.
    * Релизятся пакеты *hammond* и *tippetop-cml*.
    * Ставится теги релиза пакетов: *hammond-7.3.1*, *tippetop-cml-1.0.1*
7. Багфикс из ветки *release-hammond-bugfix*, должен попасть в мастер: предлагается перенести коммит из релиза (*FIX*) при помощи `git cherry-pick` в мастер (*FIX'*). Разрешить конфликты версий пакетов, вернуть в *hammond* интервальную зависимость от *tippetop-cml* (tippetop-cml >= 1.2.1.dev0, < 2.0.0).

##### Пример 2 – две релизные ветки с багфиксом

Был обнаружен критический баг на Проде релиза Облака. По результатам исследования, баг находится в пакете *tippetop-cml >= 1.2.x* и отражается на работе компонентов *hammond >= 7.5.0* и *keyboardist >= 7.6.0*.

На проде установлены пакеты, имеющие следующие зависимости:

* *hammond 7.8.0*, зависим от *tippetop-cml >= 1.2.x, < 2.0.0*
* *keyboardist 8.0.0*, зависим от *tippetop-cml >= 1.6.x, < 2.0.0*

Необходимо выпустить пакеты с багфиксом и принести багфикс в мастер.

Мастер имеет следующий вид:

```
---x----------------...----x---------...------------x-------------x-----------------x------------------------x---> master
   ^                       ^                        ^             ^                 ^                        ^
 tippetop-cml 1.2.0    hammond 7.5.0         hammond 7.8.0(П)   hammond 7.9.0   keyboardist 8.0.0 (П)     keyboardist 8.1.0
                                                                                tippetop-cml 1.6.0 (П)    tippetop-cml 1.7.0
```

Описание git-flow:

Багфикс в конкретной версии приведет к увеличению *PATCH* версии релиза *tippetop-cml*, *hammond* и *keyboardist*.

Как *keyboardist*, так и *hammond* зависят от одной мажорной версии *tippetop-cml*. Значит вносить багфикс имеет смысл в старшую 1.6.0, подвинув до этой версии отстающую зависимость у *hammond*.

Примечательно, что завести одну релизную ветку с багфиксом не получится (из-за *hammond* 7.9.0 в истории мастера), поэтому придется завести две ветки: одну под *hammond*, другую под *keyboardist*.

Git-flow будет иметь следующий вид:

```
---x---...------------x------------------------x-------------x------------------------...--H'---K'-----x----> master
   ^                  ^                        ^             ^                                         ^
tippetop-cml 1.2.0  hammond 7.8.0(П)     hammond 7.9.0   keyboardist 8.0.0 (П)                       hammond 7.9.1.dev0
                      |                                  tippetop-cml 1.6.0 (П)                      keyboardist 8.1.1.dev0
                      |                                      |                                       tippetop-cml 1.7.1.dev0
                      |                                      |
                      |                                      o------- K---------------x------> release-keyboardist-bugfix
                      |                                      |       /                ^
                      |                                      \--C'--/  > k-bugfix    keyboardist 8.0.1 (tippetop-cml==1.6.1)
                      |                                                              tippetop-cml 1.6.1
                      |
                      o--------H--------------x----- > release-hammond-bugfix
                      |       /               ^
                      |      /               hammond 7.8.1 (tippetop-cml == 1.2.1)
                      \--С--/ > h-bugfix     tippetop-cml 1.2.1
```

1. От тега *hammond-7.8.0* заводится релизная ветка *release-hammond-bugfix*.
2. От тега *keyboardist-8.0.0* заводится релизная ветка *release-keyboardist-bugfix*.
3. От релизной ветки *release-hammond-bugfix* заводится ветка с багфиксом *h-bug-fix*.
4. От релизной ветки *release-keyboardist-bugfix* заводится ветка с багфиксом *k-bug-fix*.
5. В ветке *h-bug-fix* делается коммит с багфиксом C и повышаются версии пакетов:
    * *hammond 7.8.0* → *7.8.1.dev0*
    * *tippetop-cml 1.2.0* → *1.2.1.dev0*
6. Зависимость *hammond* от *tippetop-cml* должна быть строго зафиксирована (tippetop-cml == 1.2.1.dev0), чтобы далее избежать установки более свежих пакетов, в которых багфикса нет.
7. Ветка *h-bugfix* вливается в ветку *release-hammond-bugfix* с `--squash`.
8. Готовится релиз пакетов с багфиксом из ветки *release-hammond-bugfix*:
    * В ветке убираются постфиксы "devN" в версиях пакетов.
    * Релизятся пакеты *hammond* и *tippetop-cml*.
    * Ставится теги релиза пакетов: *hammond-7.8.1*, *tippetop-cml-1.2.1*
9. Принимая во внимание, что аналогичные правки *tippetop-cml* должны оказаться в ветке *release-keyboarist-bugfix*, имеет смысл перенести коммит *C* (`git cherry-pick --no-commit`) в ветку *k-bugfix*.
10. Разрешим конфликты версии tippetop-cml 1.2.1.dev0 → 1.6.1.dev0.
11. Исключим притекшие изменения по *hammond*, в этой ветке они не нужны.
12. Зависимость *keyboardist* от *tippetop-cml* должна быть строго зафиксирована (tippetop-cml == 1.6.1.dev0).
13. Ветка *k-bugfix* вливается в ветку *release-keyboardist-bugfix* с `--squash`.
14. Релизятся пакеты из ветки *release-keyboardist-bugfix*: *keyboardist-8.0.1*, *tippetop-cml-1.6.1*
15. Багфиксы из веток *hammond-bugfix* и *keyboardist-bugfix*, должны попасть в мастер: предлагается перенести коммит *H* и *K* (`git cherry-pick`) в мастер. Получим коммиты *H'* и *K'*. Разрешить конфликты версий пакетов, вернуть в *hammond* и *keyboardist* интервальную зависимость от *tippetop-cml* (tippetop-cml >= 1.7.1.dev0, < 2.0.0).

##### Пример 3 – бэкпорт фичи из мажорной версии, не ломающей обратную совместимость

*Примечание*: вообще задача бэкпортирования не является тривиальной, поэтому далее рассмотрен "идеальный" пример, когда коммит с переносимой из мастера фичей / багфиксом не приносит с собой изменения из других фичей, предшествующих переносимой. Т.е. с переносом коммита приносятся необходимые и достаточные изменения для этой фичи.

Дано:

В мастере есть некоторое количество зарелиженных фичей, для условности *A*, *B* и *С*, необходимо бэкпортировать фичу *B* в релиз *hammond-7.x*, который развернут на Проде.

Пуст фича *B* имеет обратно совместимые изменения относительно версии 7.x.

Мастер имеет следующий вид:

```
-------x------------ ... ---------A----B----C----x---- > master
       ^                                         ^
   hammond 7.3.0(П)                         hammond 8.0.0
```

Описание git-flow:

Поскольку фича *B* не ломает совместимость, ее бэкпорт приведет к увеличению минорной версии пакета *hammond*, который получит версию 7.4.0.

Бэкпортирование предлагается осуществлять переносом необходимых коммитов релизную ветку командой `git cherry-pick`.

Git-flow будет иметь следующий вид.

```
-------x------------ ... ---------A----B----C----x---- > master
       ^                                         ^
   hammond 7.3.0(П)                         hammond 8.0.0
       |
       |
       |
       \----------------B'-----x  > release-hammond-7.x
                               ^
                         hammond 7.4.0
```

1. От тега *hammond-7.3.0* заводится релизная ветка *release-hammond-7.x*
2. Узнается хэш-коммита фичи (*B*) из мастера, коммит переносится в ветку *release-hammond-7.x*
3. Разрешаются конфликты, результат коммитится (*B'*).
4. Готовится релиз пакета с бэкпортом из ветки *release-hammond-7.x*:
    * У пакета *hammond* повышается минорная версия: *hammond-7.4.0*
    * Релизится пакет *hammond-7.4.0*.
    * Ставится тег релиза *hammond-7.4.0*.

##### Пример 4 – ...

⚠ **В процессе написания**

Рассмотреть более реальный случай, когда в бэкпортируемой фиче затрагиваются разные пакеты. Например, *hammond* и *tippetop-main*.

##### Пример 5 – ...

⚠ **В процессе написания**

Задача: получить пакет *hammond 7.3.0* с фичей *B*, но без фичи *A* и *C*.

```
-------x------------------x-------------A----B----C----x---- > master
       ^                  ^                            ^
   hammond 7.3.0(П)    hammond 7.4.0                hammond-7.5.0
```



[semver]: https://semver.org/
[pep440]: https://www.python.org/dev/peps/pep-0440/#pre-releases
