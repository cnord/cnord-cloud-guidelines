# Автоматическая генерация changelog’ов

Вместо ручного редактирования файлов `changelog.md` пакетов репозитория private-cloud следует использовать скрипт `update-changelog`, расположенный в корневой директории `.bin` репозитория.

Записи в ченджлог («фрагменты») кладутся в директорию `changelog.d`, расположенную на одном уровне с `changelod.md`, и именуются по следующей схеме: `{xxxx}[.{type}].md` или `{xxxx}-{short-description}[.{type}].md`, где `xxxx` — номер задачи в Jira без CLD-префикса, `type` — опциональный суффикс тип задачи (в настоящее время только одно возможное значение — `bugfix`), а `short-description` просто для наглядности.

Отсутствие суффикса типа задачи в настоящее время означает, что это задача НЕ багфикс, то есть любая задача в Jira не с типом bugfix, будь то task, subtask, improvement, и т.д.

Примеры именования файлов «фрагментов»:

```
6789.md
1234-add-technicians-table.md
9462.bugfix.md
8765-fix-technician-type.bugfix.md
```

Внутри файла «фрагмента» помещается запись в ченджлог в формате Markdown без префиксов (типа **[bugfix]**), без ведущего маркера списка и без ссылки на задачу — всё это генерируется автоматически.


## Примеры записей

* *Однострочная запись об обычной задаче (не багфиксе):*

  > ```
  > Реализованы эндпоинты постановки/снятия раздела объекта под охрану
  > ```

* *Многострочная запись об обычной задаче (не багфиксе) со списком (рекомендуется использовать для таких списков маркер «\*», т.к. скрипт использует маркер «-» для фрагментов):*

  > ```
  > Изменён список полей события в ответе эндпоинта `GET /tasks/:task_id/object/events`
  >   * Убрано незаявленное поле id
  >   * Убрано поле zone_or_user_description
  >   * Убрано поле channel
  >   * Переименовано поле channel_type -> channel_name
  >   * Добавлено поле class_name
  > ```

  Многострочная запись со списком применима для развёрнутого описания одного изменения или группы изменений, логически связанных между собой.

  Если же в рамках одной задачи в пакете были сделаны изменения, слабо связанные между собой, то альтернативой многострочной записи может быть заведение для каждого такого изменения отдельного файла «фрагмента». Для удобства и управления порядком следования таких записей в результирующем ченджлоге можно использовать одинаковое имя для всех фрагментов, добавив к концу имени порядковый номер. Для однозначного разделения имени и порядкового номера рекомендуется использовать два минуса — `--`. Например, если в рамках задачи CLD-9137 по повышению версии Tornado до 6.x в каком-то пакете были внесены три не связанных между собой изменения, имена файлов «фрагментов» могут выглядеть так:

  ```
  9137-update-to-tornado-6--1.md
  9137-update-to-tornado-6--2.md
  9137-update-to-tornado-6--3.md
  ```

* *Запись о багфиксе (обратите внимание на отсутствие префикса **[bugfix]** у записи, он будет подставлен автоматически, исходя из суффикса типа в имени фрагмента):*

  > ```
  > Хаббл 14.6 теперь работает на Windows XP
  > ```

  или

  > ```
  > Исправлено: Хаббл 14.6 не работает на Windows XP
  > ```

  или

  > ```
  > Исправили баг, при котором Хаббл 14.6 не работал на Windows XP
  > ```

  Записи о багфиксах следует формулировать таким образом, чтобы было понятно, что именно исправлено, то есть должно быть либо описание бага с указанием, что он исправлен, либо описание правильного поведения после исправления бага. Например, *«Теперь <описание корректного поведения после фикcа>»* или просто *«Исправлено: <описание бага, например, как он сформулирован в залоговке задачи в Jira>»*.


## Использование скрипта

Добавим путь к директории со скриптом в переменную окружения `PATH`:

```shell
$ export PATH="/path/to/private-cloud/.bin:$PATH"
```

Перейдём в директорию с пакетом:

```shell
$ cd path/to/package
```

Находясь в директории пакета, можем выполнить следующие действия:

  * обновить `changelog.md` (в качестве версии будет использовано `?.?.?`) и удалить фрагменты из `changelog.d`:

    ```shell
    $ update-changelog
    ```

  * то же самое, но с указанием версии, которая будет записана в `changelog.md`:

    ```shell
    $ update-changelog 7.2.3
    ```

  * посмотреть, какая запись будет добавлена в `changelog.md`, но ничего не обновлять и не удалять (аргумент `--dry-run`/`-n`):

    ```shell
    $ update-changelog -n
    ```

  * то же самое, но с указанием версии:

    ```shell
    $ update-changelog -n 7.2.3
    ```
